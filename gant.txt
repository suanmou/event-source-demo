<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Highcharts甘特图 - 全元素防重叠</title>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/gantt/highcharts-gantt.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <style>
        #gantt-chart { min-width: 800px; max-width: 1200px; height: 600px; margin: 20px auto; }
        .btn-group { text-align: center; margin: 10px 0; }
        button { padding: 8px 16px; margin: 0 5px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="btn-group">
        <button id="addTask">动态添加任务</button>
        <button id="reset">重置图表</button>
    </div>
    <div id="gantt-chart"></div>

    <script>
        let chart = Highcharts.ganttChart('gantt-chart', {
            chart: { type: 'gantt', marginLeft: 220, marginRight: 50 },
            title: { text: '项目进度甘特图（全元素防重叠）' },
            xAxis: {
                type: 'datetime',
                tickInterval: 7 * 24 * 3600 * 1000, // 按周显示刻度，减少密度
                labels: {
                    format: '{value:%Y-%m-%d}',
                    rotation: -45, // X轴标签旋转，避免重叠
                    step: 1, // 数据极多时设为2，隔行显示
                    style: { whiteSpace: 'normal' }, // 允许X轴标签换行
                    allowOverlap: false // 禁止X轴标签重叠
                },
                gridLineWidth: 0.5, // 弱化网格线，减少视觉重叠
                gridLineDashStyle: 'Dash' // 网格线设为虚线
            },
            yAxis: {
                type: 'category',
                width: 200,
                overflow: 'none',
                labels: {
                    style: { width: '200px', whiteSpace: 'normal', wordWrap: 'break-word' },
                    allowOverlap: false,
                    step: 1,
                    crop: false
                },
                minPadding: 0.08, // 增加y轴分类间距，避免任务条拥挤
                maxPadding: 0.08,
                gridLineWidth: 0 // 隐藏Y轴网格线
            },
            tooltip: {
                formatter: function() {
                    return `<b>${this.y}</b><br/>
                            开始：${Highcharts.dateFormat('%Y-%m-%d', this.point.start)}<br/>
                            结束：${Highcharts.dateFormat('%Y-%m-%d', this.point.end)}`;
                },
                delayForDisplay: 300, // 延迟显示，避免快速悬浮导致重叠
                shared: false, // 一次只显示一个提示框
                positioner: function(labelWidth, labelHeight, point) {
                    // 自定义提示框位置，避开图表边缘
                    return {
                        x: Math.max(220, point.plotX + 10), // 不超过y轴右侧
                        y: Math.max(10, point.plotY - labelHeight / 2) // 不超过图表顶部
                    };
                }
            },
            plotOptions: {
                gantt: {
                    borderRadius: 5,
                    animation: true,
                    pointPadding: 2, // 任务条上下间距
                    groupPadding: 5, // 分类之间的间距
                    allowOverlapX: false, // 禁止任务条横向重叠
                    dataLabels: {
                        enabled: true,
                        allowOverlap: false, // 禁止任务条标签重叠
                        style: {
                            whiteSpace: 'normal',
                            width: '100px',
                            textOverflow: 'ellipsis' // 超出宽度显示省略号
                        },
                        crop: true, // 标签过小时自动裁剪
                        overflow: 'none'
                    }
                }
            },
            series: [{
                name: '项目任务',
                data: [
                    { name: '需求分析（超长名称测试）', start: Date.UTC(2026, 0, 1), end: Date.UTC(2026, 0, 10), y: '需求分析（超长名称测试）' },
                    { name: 'UI设计', start: Date.UTC(2026, 0, 8), end: Date.UTC(2026, 0, 18), y: 'UI设计' },
                    { name: '前端开发', start: Date.UTC(2026, 0, 15), end: Date.UTC(2026, 1, 5), y: '前端开发' }
                ]
            }]
        });

        // 动态添加任务（模拟密集数据）
        document.getElementById('addTask').addEventListener('click', function() {
            const taskIndex = chart.series[0].data.length + 1;
            const taskName = `开发任务${taskIndex}（超长名称测试：模块${taskIndex}的详细开发与联调）`;
            // 故意让新任务与旧任务时间重叠，测试防重叠效果
            chart.series[0].addPoint({
                name: taskName,
                start: Date.UTC(2026, 1, taskIndex - 2), // 时间重叠
                end: Date.UTC(2026, 1, taskIndex + 3),
                y: taskIndex > 8 ? `分类${Math.floor(taskIndex/3)}` : taskName // 部分任务归为同一分类，测试堆叠
            });
            // 数据超过8条时，调整X/Y轴标签step
            if (chart.series[0].data.length > 8) {
                chart.yAxis[0].update({ labels: { step: 2 } });
                chart.xAxis[0].update({ labels: { step: 2 } });
            }
        });

        document.getElementById('reset').addEventListener('click', function() {
            chart.series[0].setData([
                { name: '需求分析（超长名称测试）', start: Date.UTC(2026, 0, 1), end: Date.UTC(2026, 0, 10), y: '需求分析（超长名称测试）' },
                { name: 'UI设计', start: Date.UTC(2026, 0, 8), end: Date.UTC(2026, 0, 18), y: 'UI设计' },
                { name: '前端开发', start: Date.UTC(2026, 0, 15), end: Date.UTC(2026, 1, 5), y: '前端开发' }
            ]);
            chart.yAxis[0].update({ labels: { step: 1 } });
            chart.xAxis[0].update({ labels: { step: 1 } });
        });
    </script>
</body>
</html>