<template>
  <div class="session-manager">
    <!-- 头部区域 -->
    <el-header class="header">
      <div class="title">FIX Session 管理中心</div>
      <el-input
        v-model="searchKeyword"
        placeholder="搜索 Session ID/SenderCompID/TargetCompID"
        prefix-icon="el-icon-search"
        class="search-input"
        @input="handleSearch"
      ></el-input>
    </el-header>

    <!-- 主内容区域 -->
    <el-main class="main-content">
      <!-- 操作工具栏 -->
      <el-row class="toolbar">
        <el-col :span="4">
          <el-button type="primary" icon="el-icon-plus" @click="openAddDialog">
            新增 Session
          </el-button>
        </el-col>
        <el-col :span="20" class="filter-bar">
          <el-select
            v-model="filterStatus"
            placeholder="筛选状态"
            clearable
            class="filter-item"
            @change="handleFilter"
          >
            <el-option label="活跃" value="active"></el-option>
            <el-option label="离线" value="offline"></el-option>
            <el-option label="异常" value="error"></el-option>
          </el-select>
          <el-select
            v-model="filterVersion"
            placeholder="筛选协议版本"
            clearable
            class="filter-item"
            @change="handleFilter"
          >
            <el-option label="FIX.4.4" value="FIX.4.4"></el-option>
            <el-option label="FIX.5.0" value="FIX.5.0"></el-option>
            <el-option label="FIXT.1.1" value="FIXT.1.1"></el-option>
          </el-select>
          <el-button type="default" icon="el-icon-refresh" @click="resetFilter">
            重置筛选
          </el-button>
        </el-col>
      </el-row>

      <!-- Session 列表 -->
      <el-table
        :data="filteredSessions"
        border
        stripe
        size="mini"
        style="width: 100%; margin-top: 10px"
      >
        <el-table-column
          prop="sessionId"
          label="Session ID"
          width="300"
          sortable
        ></el-table-column>
        <el-table-column
          prop="beginString"
          label="协议版本"
          width="120"
          sortable
        ></el-table-column>
        <el-table-column
          prop="senderCompID"
          label="发送方标识"
          width="180"
          sortable
        ></el-table-column>
        <el-table-column
          prop="targetCompID"
          label="接收方标识"
          width="180"
          sortable
        ></el-table-column>
        <el-table-column
          prop="status"
          label="状态"
          width="120"
          sortable
        >
          <template slot-scope="scope">
            <el-tag
              :type="
                scope.row.status === 'active'
                  ? 'success'
                  : scope.row.status === 'offline'
                  ? 'info'
                  : 'danger'
              "
            >
              {{ scope.row.status === 'active' ? '活跃' : scope.row.status === 'offline' ? '离线' : '异常' }}
            </el-tag>
          </template>
        </el-table-column>
        <el-table-column
          prop="heartbeatInterval"
          label="心跳间隔(秒)"
          width="130"
        ></el-table-column>
        <el-table-column
          prop="createTime"
          label="创建时间"
          width="180"
          sortable
        ></el-table-column>
        <el-table-column
          prop="lastActiveTime"
          label="最近活动时间"
          width="180"
        ></el-table-column>
        <el-table-column label="操作" width="200">
          <template slot-scope="scope">
            <el-button
              size="mini"
              type="text"
              icon="el-icon-view"
              @click="viewSessionDetail(scope.row)"
            >
              查看
            </el-button>
            <el-button
              size="mini"
              type="text"
              icon="el-icon-edit"
              @click="openEditDialog(scope.row)"
            >
              编辑
            </el-button>
            <el-button
              size="mini"
              type="text"
              icon="el-icon-delete"
              style="color: #f56c6c"
              @click="handleDelete(scope.row)"
            >
              删除
            </el-button>
          </template>
        </el-table-column>
      </el-table>

      <!-- 分页 -->
      <el-pagination
        @size-change="handleSizeChange"
        @current-change="handleCurrentChange"
        :current-page="currentPage"
        :page-sizes="[10, 20, 50, 100]"
        :page-size="pageSize"
        layout="total, sizes, prev, pager, next, jumper"
        :total="filteredSessions.length"
        style="margin-top: 15px; text-align: right"
      ></el-pagination>
    </el-main>

    <!-- 新增/编辑 Session 弹窗 -->
    <el-dialog
      :title="isEdit ? '编辑 Session' : '新增 Session'"
      :visible.sync="dialogVisible"
      width="600px"
      :close-on-click-modal="false"
    >
      <el-form
        ref="sessionForm"
        :model="formData"
        :rules="formRules"
        label-width="140px"
        size="small"
      >
        <el-form-item label="协议版本(BeginString)" prop="beginString">
          <el-select v-model="formData.beginString" placeholder="选择协议版本">
            <el-option label="FIX.4.4" value="FIX.4.4"></el-option>
            <el-option label="FIX.5.0" value="FIX.5.0"></el-option>
            <el-option label="FIXT.1.1" value="FIXT.1.1"></el-option>
          </el-select>
        </el-form-item>
        <el-form-item label="发送方标识(SenderCompID)" prop="senderCompID">
          <el-input v-model="formData.senderCompID" placeholder="如 BROKER_X"></el-input>
        </el-form-item>
        <el-form-item label="接收方标识(TargetCompID)" prop="targetCompID">
          <el-input v-model="formData.targetCompID" placeholder="如 EXCHANGE_A"></el-input>
        </el-form-item>
        <el-form-item label="子标识(SenderSubID)" prop="senderSubID">
          <el-input v-model="formData.senderSubID" placeholder="如 EQ_DESK (可选)"></el-input>
        </el-form-item>
        <el-form-item label="位置标识(SenderLocationID)">
          <el-input v-model="formData.senderLocationID" placeholder="如 SH-DC1 (可选)"></el-input>
        </el-form-item>
        <el-form-item label="心跳间隔(秒)" prop="heartbeatInterval">
          <el-input
            v-model.number="formData.heartbeatInterval"
            type="number"
            min="5"
            max="300"
          ></el-input>
        </el-form-item>
        <el-form-item label="描述信息">
          <el-input
            v-model="formData.description"
            type="textarea"
            rows="3"
            placeholder="请输入备注信息"
          ></el-input>
        </el-form-item>
      </el-form>
      <div slot="footer" class="dialog-footer">
        <el-button @click="dialogVisible = false">取消</el-button>
        <el-button type="primary" @click="submitForm">确认</el-button>
      </div>
    </el-dialog>

    <!-- Session 详情弹窗 -->
    <el-dialog
      title="Session 详情"
      :visible.sync="detailVisible"
      width="700px"
      :close-on-click-modal="false"
    >
      <el-descriptions column="1" border size="small">
        <el-descriptions-item label="Session ID">{{ detailData.sessionId }}</el-descriptions-item>
        <el-descriptions-item label="协议版本">{{ detailData.beginString }}</el-descriptions-item>
        <el-descriptions-item label="发送方标识">{{ detailData.senderCompID }}</el-descriptions-item>
        <el-descriptions-item label="接收方标识">{{ detailData.targetCompID }}</el-descriptions-item>
        <el-descriptions-item label="子标识">{{ detailData.senderSubID || '-' }}</el-descriptions-item>
        <el-descriptions-item label="位置标识">{{ detailData.senderLocationID || '-' }}</el-descriptions-item>
        <el-descriptions-item label="状态">
          <el-tag
            :type="
              detailData.status === 'active'
                ? 'success'
                : detailData.status === 'offline'
                ? 'info'
                : 'danger'
            "
          >
            {{ detailData.status === 'active' ? '活跃' : detailData.status === 'offline' ? '离线' : '异常' }}
          </el-tag>
        </el-descriptions-item>
        <el-descriptions-item label="心跳间隔">
          {{ detailData.heartbeatInterval }} 秒
        </el-descriptions-item>
        <el-descriptions-item label="创建时间">{{ detailData.createTime }}</el-descriptions-item>
        <el-descriptions-item label="最近活动时间">{{ detailData.lastActiveTime || '-' }}</el-descriptions-item>
        <el-descriptions-item label="描述信息">{{ detailData.description || '-' }}</el-descriptions-item>
      </el-descriptions>
    </el-dialog>
  </div>
</template>

<script>
export default {
  name: 'SessionManager',
  data() {
    return {
      // 搜索与筛选
      searchKeyword: '',
      filterStatus: '',
      filterVersion: '',
      
      // 分页配置
      currentPage: 1,
      pageSize: 10,
      
      // 弹窗控制
      dialogVisible: false,
      detailVisible: false,
      isEdit: false,
      
      // 表单数据
      formData: {
        beginString: '',
        senderCompID: '',
        targetCompID: '',
        senderSubID: '',
        senderLocationID: '',
        heartbeatInterval: 30,
        description: ''
      },
      
      // 详情数据
      detailData: {},
      
      // 表单验证规则
      formRules: {
        beginString: [{ required: true, message: '请选择协议版本', trigger: 'change' }],
        senderCompID: [{ required: true, message: '请输入发送方标识', trigger: 'blur' }],
        targetCompID: [{ required: true, message: '请输入接收方标识', trigger: 'blur' }],
        heartbeatInterval: [
          { required: true, message: '请输入心跳间隔', trigger: 'blur' },
          { type: 'number', min: 5, max: 300, message: '心跳间隔需在5-300秒之间', trigger: 'blur' }
        ]
      },
      
      // 原始 Session 数据
      sessions: [
        {
          sessionId: 'FIX.4.4:BROKER_X:EXCHANGE_A',
          beginString: 'FIX.4.4',
          senderCompID: 'BROKER_X',
          targetCompID: 'EXCHANGE_A',
          senderSubID: 'EQ_DESK',
          senderLocationID: 'SH-DC1',
          status: 'active',
          heartbeatInterval: 30,
          createTime: '2023-10-01 09:30:00',
          lastActiveTime: '2023-10-05 15:45:22',
          description: '股票交易部对接交易所A的主连接'
        },
        {
          sessionId: 'FIX.5.0:BROKER_X:EXCHANGE_B',
          beginString: 'FIX.5.0',
          senderCompID: 'BROKER_X',
          targetCompID: 'EXCHANGE_B',
          senderSubID: 'FX_DESK',
          senderLocationID: 'SH-DC1',
          status: 'offline',
          heartbeatInterval: 60,
          createTime: '2023-10-02 10:15:00',
          lastActiveTime: '2023-10-04 18:20:10',
          description: '外汇交易部对接交易所B的连接'
        },
        {
          sessionId: 'FIXT.1.1:BANK_Y:CLEARING_C',
          beginString: 'FIXT.1.1',
          senderCompID: 'BANK_Y',
          targetCompID: 'CLEARING_C',
          senderSubID: 'RISK',
          senderLocationID: 'BJ-DC2',
          status: 'error',
          heartbeatInterval: 45,
          createTime: '2023-09-28 14:20:00',
          lastActiveTime: '2023-10-05 10:10:33',
          description: 'Y银行风控部对接清算所C的连接（序号冲突）'
        }
      ]
    }
  },
  computed: {
    // 筛选后的 Session 列表
    filteredSessions() {
      return this.sessions.filter(session => {
        // 搜索关键词筛选
        const matchSearch = this.searchKeyword
          ? session.sessionId.includes(this.searchKeyword) ||
            session.senderCompID.includes(this.searchKeyword) ||
            session.targetCompID.includes(this.searchKeyword)
          : true;
        
        // 状态筛选
        const matchStatus = this.filterStatus ? session.status === this.filterStatus : true;
        
        // 版本筛选
        const matchVersion = this.filterVersion ? session.beginString === this.filterVersion : true;
        
        return matchSearch && matchStatus && matchVersion;
      });
    }
  },
  methods: {
    // 搜索处理
    handleSearch() {
      this.currentPage = 1; // 重置页码
    },
    
    // 筛选处理
    handleFilter() {
      this.currentPage = 1; // 重置页码
    },
    
    // 重置筛选
    resetFilter() {
      this.searchKeyword = '';
      this.filterStatus = '';
      this.filterVersion = '';
      this.currentPage = 1;
    },
    
    // 分页尺寸变更
    handleSizeChange(size) {
      this.pageSize = size;
    },
    
    // 分页页码变更
    handleCurrentChange(page) {
      this.currentPage = page;
    },
    
    // 打开新增弹窗
    openAddDialog() {
      this.isEdit = false;
      this.formData = {
        beginString: '',
        senderCompID: '',
        targetCompID: '',
        senderSubID: '',
        senderLocationID: '',
        heartbeatInterval: 30,
        description: ''
      };
      this.dialogVisible = true;
    },
    
    // 打开编辑弹窗
    openEditDialog(row) {
      this.isEdit = true;
      this.formData = { ...row };
      this.dialogVisible = true;
    },
    
    // 查看详情
    viewSessionDetail(row) {
      this.detailData = { ...row };
      this.detailVisible = true;
    },
    
    // 提交表单（新增/编辑）
    submitForm() {
      this.$refs.sessionForm.validate(valid => {
        if (valid) {
          const sessionId = `${this.formData.beginString}:${this.formData.senderCompID}:${this.formData.targetCompID}`;
          
          // 检查 Session ID 唯一性（新增时）
          if (!this.isEdit && this.sessions.some(s => s.sessionId === sessionId)) {
            this.$message.error('Session ID 已存在（协议版本+发送方+接收方组合需唯一）');
            return;
          }
          
          if (this.isEdit) {
            // 编辑模式：替换原数据
            const index = this.sessions.findIndex(s => s.sessionId === this.formData.sessionId);
            this.sessions.splice(index, 1, { ...this.formData, sessionId });
            this.$message.success('Session 编辑成功');
          } else {
            // 新增模式：添加新数据
            const newSession = {
              ...this.formData,
              sessionId,
              status: 'offline', // 新增默认离线状态
              createTime: new Date().toLocaleString(),
              lastActiveTime: ''
            };
            this.sessions.unshift(newSession); // 新增数据放最前
            this.$message.success('Session 新增成功');
          }
          
          this.dialogVisible = false;
        }
      });
    },
    
    // 删除 Session
    handleDelete(row) {
      this.$confirm(`确定要删除 Session [${row.sessionId}] 吗？删除后不可恢复`, '确认删除', {
        confirmButtonText: '确定',
        cancelButtonText: '取消',
        type: 'warning'
      }).then(() => {
        const index = this.sessions.findIndex(s => s.sessionId === row.sessionId);
        this.sessions.splice(index, 1);
        this.$message.success('删除成功');
      }).catch(() => {
        // 取消删除
      });
    }
  }
};
</script>

<style scoped>
.session-manager {
  height: 100vh;
  display: flex;
  flex-direction: column;
  background-color: #f5f7fa;
}

.header {
  background-color: #2c3e50;
  color: white;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 20px;
}

.title {
  font-size: 18px;
  font-weight: bold;
}

.search-input {
  width: 350px;
}

.main-content {
  flex: 1;
  padding: 20px;
  overflow: auto;
}

.toolbar {
  margin-bottom: 10px;
}

.filter-bar {
  display: flex;
  justify-content: flex-end;
  align-items: center;
  gap: 10px;
}

.filter-item {
  width: 180px;
}

/* 解决弹窗表单label过长问题 */
::v-deep .el-form-item__label {
  white-space: nowrap;
}
</style>


<template>
  <div class="user-manager">
    <!-- 头部 -->
    <el-header class="header">
      <div class="title">用户管理（关联 Session）</div>
      <el-input
        v-model="searchKeyword"
        placeholder="搜索用户名/用户ID/所属机构"
        prefix-icon="el-icon-search"
        class="search-input"
        @input="handleSearch"
      ></el-input>
    </el-header>

    <!-- 主内容 -->
    <el-main class="main-content">
      <!-- 操作栏 -->
      <el-row class="toolbar">
        <el-col :span="4">
          <el-button type="primary" icon="el-icon-plus" @click="openAddDialog">
            新增用户
          </el-button>
        </el-col>
        <el-col :span="20" class="filter-bar">
          <el-select
            v-model="filterRole"
            placeholder="筛选角色"
            clearable
            class="filter-item"
            @change="handleFilter"
          >
            <el-option label="管理员" value="admin"></el-option>
            <el-option label="操作员" value="operator"></el-option>
            <el-option label="只读用户" value="viewer"></el-option>
          </el-select>
          <el-select
            v-model="filterStatus"
            placeholder="筛选状态"
            clearable
            class="filter-item"
            @change="handleFilter"
          >
            <el-option label="启用" value="enabled"></el-option>
            <el-option label="禁用" value="disabled"></el-option>
          </el-select>
          <el-button type="default" icon="el-icon-refresh" @click="resetFilter">
            重置筛选
          </el-button>
        </el-col>
      </el-row>

      <!-- 用户列表 -->
      <el-table
        :data="filteredUsers"
        border
        stripe
        size="mini"
        style="width: 100%; margin-top: 10px"
      >
        <el-table-column prop="userId" label="用户ID" width="150" sortable></el-table-column>
        <el-table-column prop="username" label="用户名" width="150" sortable></el-table-column>
        <el-table-column prop="fullName" label="姓名" width="150"></el-table-column>
        <el-table-column prop="institution" label="所属机构" width="200" sortable></el-table-column>
        <el-table-column prop="role" label="角色" width="120">
          <template slot-scope="scope">
            <el-tag :type="scope.row.role === 'admin' ? 'primary' : 'info'">
              {{ scope.row.role === 'admin' ? '管理员' : scope.row.role === 'operator' ? '操作员' : '只读用户' }}
            </el-tag>
          </template>
        </el-table-column>
        <el-table-column prop="status" label="状态" width="120">
          <template slot-scope="scope">
            <el-tag :type="scope.row.status === 'enabled' ? 'success' : 'danger'">
              {{ scope.row.status === 'enabled' ? '启用' : '禁用' }}
            </el-tag>
          </template>
        </el-table-column>
        <el-table-column prop="createTime" label="创建时间" width="180"></el-table-column>
        <el-table-column label="关联Session数" width="150">
          <template slot-scope="scope">
            <el-button
              type="text"
              @click="viewUserSessions(scope.row)"
              :disabled="scope.row.sessionIds.length === 0"
            >
              {{ scope.row.sessionIds.length }} 个
            </el-button>
          </template>
        </el-table-column>
        <el-table-column label="操作" width="200">
          <template slot-scope="scope">
            <el-button
              size="mini"
              type="text"
              icon="el-icon-edit"
              @click="openEditDialog(scope.row)"
            >
              编辑
            </el-button>
            <el-button
              size="mini"
              type="text"
              :style="scope.row.status === 'enabled' ? 'color: #f56c6c' : 'color: #409eff'"
              @click="toggleStatus(scope.row)"
            >
              {{ scope.row.status === 'enabled' ? '禁用' : '启用' }}
            </el-button>
          </template>
        </el-table-column>
      </el-table>

      <!-- 分页 -->
      <el-pagination
        @size-change="handleSizeChange"
        @current-change="handleCurrentChange"
        :current-page="currentPage"
        :page-sizes="[10, 20, 50]"
        :page-size="pageSize"
        layout="total, sizes, prev, pager, next, jumper"
        :total="filteredUsers.length"
        style="margin-top: 15px; text-align: right"
      ></el-pagination>
    </el-main>

    <!-- 新增/编辑用户弹窗 -->
    <el-dialog
      :title="isEdit ? '编辑用户' : '新增用户'"
      :visible.sync="dialogVisible"
      width="500px"
      :close-on-click-modal="false"
    >
      <el-form
        ref="userForm"
        :model="formData"
        :rules="formRules"
        label-width="120px"
        size="small"
      >
        <el-form-item label="用户ID" prop="userId" v-if="isEdit">
          <el-input v-model="formData.userId" disabled placeholder="自动生成"></el-input>
        </el-form-item>
        <el-form-item label="用户名" prop="username">
          <el-input v-model="formData.username" placeholder="登录用户名"></el-input>
        </el-form-item>
        <el-form-item label="姓名" prop="fullName">
          <el-input v-model="formData.fullName" placeholder="用户真实姓名"></el-input>
        </el-form-item>
        <el-form-item label="所属机构" prop="institution">
          <el-input v-model="formData.institution" placeholder="如 BROKER_X"></el-input>
        </el-form-item>
        <el-form-item label="角色" prop="role">
          <el-select v-model="formData.role" placeholder="选择角色">
            <el-option label="管理员" value="admin"></el-option>
            <el-option label="操作员" value="operator"></el-option>
            <el-option label="只读用户" value="viewer"></el-option>
          </el-select>
        </el-form-item>
        <el-form-item label="关联Session" prop="sessionIds">
          <el-select
            v-model="formData.sessionIds"
            multiple
            placeholder="选择该用户可管理的Session"
            style="width: 100%"
          >
            <el-option
              v-for="session in allSessions"
              :key="session.sessionId"
              :label="session.sessionId"
              :value="session.sessionId"
            ></el-option>
          </el-select>
          <div style="color: #666; font-size: 12px; margin-top: 5px">
            提示：选择后，该用户将拥有关联Session的管理权限
          </div>
        </el-form-item>
      </el-form>
      <div slot="footer" class="dialog-footer">
        <el-button @click="dialogVisible = false">取消</el-button>
        <el-button type="primary" @click="submitForm">确认</el-button>
      </div>
    </el-dialog>

    <!-- 用户关联的Session弹窗 -->
    <el-dialog
      :title="`用户 [${userSessionsTitle}] 关联的Session`"
      :visible.sync="userSessionsVisible"
      width="800px"
    >
      <el-table
        :data="userSessions"
        border
        size="mini"
        style="width: 100%"
      >
        <el-table-column prop="sessionId" label="Session ID" width="300"></el-table-column>
        <el-table-column prop="beginString" label="协议版本" width="120"></el-table-column>
        <el-table-column prop="senderCompID" label="发送方标识" width="180"></el-table-column>
        <el-table-column prop="targetCompID" label="接收方标识" width="180"></el-table-column>
        <el-table-column prop="status" label="状态" width="120">
          <template slot-scope="scope">
            <el-tag
              :type="
                scope.row.status === 'active' ? 'success' :
                scope.row.status === 'offline' ? 'info' : 'danger'
              "
            >
              {{ scope.row.status === 'active' ? '活跃' : scope.row.status === 'offline' ? '离线' : '异常' }}
            </el-tag>
          </template>
        </el-table-column>
        <el-table-column label="操作" width="100">
          <template slot-scope="scope">
            <el-button
              size="mini"
              type="text"
              @click="goToSessionDetail(scope.row.sessionId)"
            >
              详情
            </el-button>
          </template>
        </el-table-column>
      </el-table>
    </el-dialog>
  </div>
</template>

<script>
export default {
  name: 'UserManager',
  props: {
    // 接收所有Session数据（从父组件或全局状态获取）
    allSessions: {
      type: Array,
      default: () => []
    }
  },
  data() {
    return {
      // 搜索与筛选
      searchKeyword: '',
      filterRole: '',
      filterStatus: '',
      
      // 分页
      currentPage: 1,
      pageSize: 10,
      
      // 弹窗控制
      dialogVisible: false,
      userSessionsVisible: false,
      isEdit: false,
      userSessionsTitle: '',
      userSessions: [],
      
      // 表单数据
      formData: {
        userId: '',
        username: '',
        fullName: '',
        institution: '',
        role: '',
        status: 'enabled',
        sessionIds: [] // 关联的Session ID列表
      },
      
      // 表单验证
      formRules: {
        username: [{ required: true, message: '请输入用户名', trigger: 'blur' }],
        fullName: [{ required: true, message: '请输入姓名', trigger: 'blur' }],
        institution: [{ required: true, message: '请输入所属机构', trigger: 'blur' }],
        role: [{ required: true, message: '请选择角色', trigger: 'change' }]
      },
      
      // 用户数据（实际项目中从API获取）
      users: [
        {
          userId: 'U001',
          username: 'admin_x',
          fullName: '张三',
          institution: 'BROKER_X',
          role: 'admin',
          status: 'enabled',
          createTime: '2023-10-01 09:00:00',
          sessionIds: ['FIX.4.4:BROKER_X:EXCHANGE_A', 'FIX.5.0:BROKER_X:EXCHANGE_B']
        },
        {
          userId: 'U002',
          username: 'operator_y',
          fullName: '李四',
          institution: 'BANK_Y',
          role: 'operator',
          status: 'enabled',
          createTime: '2023-10-02 10:30:00',
          sessionIds: ['FIXT.1.1:BANK_Y:CLEARING_C']
        },
        {
          userId: 'U003',
          username: 'viewer_z',
          fullName: '王五',
          institution: 'BROKER_X',
          role: 'viewer',
          status: 'disabled',
          createTime: '2023-10-03 14:00:00',
          sessionIds: ['FIX.4.4:BROKER_X:EXCHANGE_A']
        }
      ]
    };
  },
  computed: {
    // 筛选后的用户列表
    filteredUsers() {
      return this.users.filter(user => {
        // 关键词筛选
        const matchSearch = this.searchKeyword
          ? user.userId.includes(this.searchKeyword) ||
            user.username.includes(this.searchKeyword) ||
            user.institution.includes(this.searchKeyword)
          : true;
        
        // 角色筛选
        const matchRole = this.filterRole ? user.role === this.filterRole : true;
        
        // 状态筛选
        const matchStatus = this.filterStatus ? user.status === this.filterStatus : true;
        
        return matchSearch && matchRole && matchStatus;
      });
    }
  },
  methods: {
    // 搜索与筛选
    handleSearch() { this.currentPage = 1; },
    handleFilter() { this.currentPage = 1; },
    resetFilter() {
      this.searchKeyword = '';
      this.filterRole = '';
      this.filterStatus = '';
      this.currentPage = 1;
    },
    
    // 分页
    handleSizeChange(size) { this.pageSize = size; },
    handleCurrentChange(page) { this.currentPage = page; },
    
    // 打开新增/编辑弹窗
    openAddDialog() {
      this.isEdit = false;
      this.formData = {
        userId: '',
        username: '',
        fullName: '',
        institution: '',
        role: '',
        status: 'enabled',
        sessionIds: []
      };
      this.dialogVisible = true;
    },
    openEditDialog(row) {
      this.isEdit = true;
      this.formData = { ...row };
      this.dialogVisible = true;
    },
    
    // 提交表单
    submitForm() {
      this.$refs.userForm.validate(valid => {
        if (valid) {
          if (this.isEdit) {
            // 编辑用户：更新关联的Session（同步到Session的userId）
            const index = this.users.findIndex(u => u.userId === this.formData.userId);
            this.users.splice(index, 1, this.formData);
            this.$message.success('用户编辑成功');
          } else {
            // 新增用户：生成唯一userId
            const newUser = {
              ...this.formData,
              userId: `U${Math.floor(100 + Math.random() * 900)}`, // 简单生成唯一ID
              createTime: new Date().toLocaleString()
            };
            this.users.push(newUser);
            this.$message.success('用户新增成功');
          }
          this.dialogVisible = false;
          // 通知父组件更新Session的userId关联（实际项目中通过API同步）
          this.$emit('update-session-user', this.formData);
        }
      });
    },
    
    // 切换用户状态
    toggleStatus(row) {
      const newStatus = row.status === 'enabled' ? 'disabled' : 'enabled';
      this.$confirm(`确定要${newStatus === 'enabled' ? '启用' : '禁用'}用户 [${row.username}] 吗？`, '确认操作', {
        type: 'warning'
      }).then(() => {
        row.status = newStatus;
        this.$message.success(`用户已${newStatus === 'enabled' ? '启用' : '禁用'}`);
      });
    },
    
    // 查看用户关联的Session
    viewUserSessions(user) {
      this.userSessionsTitle = user.username;
      // 筛选出该用户关联的Session
      this.userSessions = this.allSessions.filter(s => 
        user.sessionIds.includes(s.sessionId)
      );
      this.userSessionsVisible = true;
    },
    
    // 跳转到Session详情（实际项目中通过路由跳转）
    goToSessionDetail(sessionId) {
      this.userSessionsVisible = false;
      this.$emit('goto-session-detail', sessionId);
    }
  }
};
</script>

<style scoped>
.user-manager {
  height: 100vh;
  display: flex;
  flex-direction: column;
  background-color: #f5f7fa;
}

.header {
  background-color: #2c3e50;
  color: white;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 20px;
}

.title {
  font-size: 18px;
  font-weight: bold;
}

.search-input {
  width: 350px;
}

.main-content {
  flex: 1;
  padding: 20px;
  overflow: auto;
}

.toolbar {
  margin-bottom: 10px;
}

.filter-bar {
  display: flex;
  justify-content: flex-end;
  align-items: center;
  gap: 10px;
}

.filter-item {
  width: 180px;
}
</style>



<template>
  <div class="session-manager">
    <!-- 头部 -->
    <el-header class="header">
      <div class="title">Session管理（关联用户）</div>
      <el-input
        v-model="searchKeyword"
        placeholder="搜索Session ID/发送方/接收方"
        prefix-icon="el-icon-search"
        class="search-input"
        @input="handleSearch"
      ></el-input>
    </el-header>

    <!-- 主内容 -->
    <el-main class="main-content">
      <!-- 操作栏 -->
      <el-row class="toolbar">
        <el-col :span="4">
          <el-button type="primary" icon="el-icon-plus" @click="openAddDialog">
            新增Session
          </el-button>
        </el-col>
        <el-col :span="20" class="filter-bar">
          <!-- 新增：按用户筛选 -->
          <el-select
            v-model="filterUserId"
            placeholder="按用户筛选"
            clearable
            class="filter-item"
            @change="handleFilter"
          >
            <el-option
              v-for="user in users"
              :key="user.userId"
              :label="`${user.username}(${user.userId})`"
              :value="user.userId"
            ></el-option>
          </el-select>
          <el-select
            v-model="filterStatus"
            placeholder="筛选状态"
            clearable
            class="filter-item"
            @change="handleFilter"
          >
            <el-option label="活跃" value="active"></el-option>
            <el-option label="离线" value="offline"></el-option>
            <el-option label="异常" value="error"></el-option>
          </el-select>
          <el-button type="default" icon="el-icon-refresh" @click="resetFilter">
            重置筛选
          </el-button>
        </el-col>
      </el-row>

      <!-- Session列表（新增用户关联列） -->
      <el-table
        :data="filteredSessions"
        border
        stripe
        size="mini"
        style="width: 100%; margin-top: 10px"
      >
        <el-table-column prop="sessionId" label="Session ID" width="300" sortable></el-table-column>
        <el-table-column prop="beginString" label="协议版本" width="120"></el-table-column>
        <el-table-column prop="senderCompID" label="发送方标识" width="180"></el-table-column>
        <el-table-column prop="targetCompID" label="接收方标识" width="180"></el-table-column>
        <!-- 新增：关联用户列 -->
        <el-table-column label="关联用户" width="200">
          <template slot-scope="scope">
            <el-tag type="info" v-if="scope.row.userId">
              {{ getUserUsername(scope.row.userId) || '未知用户' }}
            </el-tag>
            <span v-else>未关联</span>
          </template>
        </el-table-column>
        <el-table-column prop="status" label="状态" width="120">
          <template slot-scope="scope">
            <el-tag
              :type="scope.row.status === 'active' ? 'success' : scope.row.status === 'offline' ? 'info' : 'danger'"
            >
              {{ scope.row.status === 'active' ? '活跃' : scope.row.status === 'offline' ? '离线' : '异常' }}
            </el-tag>
          </template>
        </el-table-column>
        <el-table-column prop="createTime" label="创建时间" width="180"></el-table-column>
        <el-table-column label="操作" width="200">
          <template slot-scope="scope">
            <el-button
              size="mini"
              type="text"
              icon="el-icon-view"
              @click="viewSessionDetail(scope.row)"
            >
              查看
            </el-button>
            <el-button
              size="mini"
              type="text"
              icon="el-icon-edit"
              @click="openEditDialog(scope.row)"
            >
              编辑
            </el-button>
            <el-button
              size="mini"
              type="text"
              style="color: #f56c6c"
              @click="handleDelete(scope.row)"
            >
              删除
            </el-button>
          </template>
        </el-table-column>
      </el-table>

      <!-- 分页 -->
      <el-pagination
        @size-change="handleSizeChange"
        @current-change="handleCurrentChange"
        :current-page="currentPage"
        :page-sizes="[10, 20, 50]"
        :page-size="pageSize"
        layout="total, sizes, prev, pager, next, jumper"
        :total="filteredSessions.length"
        style="margin-top: 15px; text-align: right"
      ></el-pagination>
    </el-main>

    <!-- 新增/编辑Session弹窗（新增用户选择） -->
    <el-dialog
      :title="isEdit ? '编辑Session' : '新增Session'"
      :visible.sync="dialogVisible"
      width="600px"
    >
      <el-form
        ref="sessionForm"
        :model="formData"
        :rules="formRules"
        label-width="140px"
        size="small"
      >
        <!-- 原有字段 -->
        <el-form-item label="协议版本(BeginString)" prop="beginString">
          <el-select v-model="formData.beginString" placeholder="选择协议版本">
            <el-option label="FIX.4.4" value="FIX.4.4"></el-option>
            <el-option label="FIX.5.0" value="FIX.5.0"></el-option>
            <el-option label="FIXT.1.1" value="FIXT.1.1"></el-option>
          </el-select>
        </el-form-item>
        <el-form-item label="发送方标识(SenderCompID)" prop="senderCompID">
          <el-input v-model="formData.senderCompID" placeholder="如 BROKER_X"></el-input>
        </el-form-item>
        <el-form-item label="接收方标识(TargetCompID)" prop="targetCompID">
          <el-input v-model="formData.targetCompID" placeholder="如 EXCHANGE_A"></el-input>
        </el-form-item>
        <!-- 新增：关联用户选择 -->
        <el-form-item label="关联用户" prop="userId">
          <el-select
            v-model="formData.userId"
            placeholder="选择Session所属用户（可选）"
            clearable
          >
            <el-option
              v-for="user in users"
              :key="user.userId"
              :label="`${user.username}(${user.userId})`"
              :value="user.userId"
            ></el-option>
          </el-select>
        </el-form-item>
        <el-form-item label="心跳间隔(秒)" prop="heartbeatInterval">
          <el-input v-model.number="formData.heartbeatInterval" type="number" min="5" max="300"></el-input>
        </el-form-item>
      </el-form>
      <div slot="footer">
        <el-button @click="dialogVisible = false">取消</el-button>
        <el-button type="primary" @click="submitForm">确认</el-button>
      </div>
    </el-dialog>

    <!-- 详情弹窗（展示关联用户） -->
    <el-dialog
      title="Session详情"
      :visible.sync="detailVisible"
      width="700px"
    >
      <el-descriptions column="1" border size="small">
        <el-descriptions-item label="Session ID">{{ detailData.sessionId }}</el-descriptions-item>
        <el-descriptions-item label="关联用户">
          {{ detailData.userId ? getUserUsername(detailData.userId) : '未关联' }}
          <span v-if="detailData.userId"> ({{ detailData.userId }})</span>
        </el-descriptions-item>
        <!-- 其他详情字段 -->
        <el-descriptions-item label="协议版本">{{ detailData.beginString }}</el-descriptions-item>
        <el-descriptions-item label="发送方标识">{{ detailData.senderCompID }}</el-descriptions-item>
        <el-descriptions-item label="接收方标识">{{ detailData.targetCompID }}</el-descriptions-item>
        <el-descriptions-item label="状态">
          <el-tag :type="detailData.status === 'active' ? 'success' : detailData.status === 'offline' ? 'info' : 'danger'">
            {{ detailData.status === 'active' ? '活跃' : detailData.status === 'offline' ? '离线' : '异常' }}
          </el-tag>
        </el-descriptions-item>
      </el-descriptions>
    </el-dialog>
  </div>
</template>

<script>
export default {
  name: 'SessionManagerWithUser',
  props: {
    // 接收所有用户数据（从父组件或全局状态获取）
    users: {
      type: Array,
      default: () => []
    }
  },
  data() {
    return {
      // 搜索与筛选（新增按用户筛选）
      searchKeyword: '',
      filterStatus: '',
      filterUserId: '',
      
      // 分页
      currentPage: 1,
      pageSize: 10,
      
      // 弹窗控制
      dialogVisible: false,
      detailVisible: false,
      isEdit: false,
      
      // 表单数据（新增userId字段关联用户）
      formData: {
        sessionId: '',
        beginString: '',
        senderCompID: '',
        targetCompID: '',
        userId: '', // 关联的用户ID
        heartbeatInterval: 30
      },
      
      detailData: {},
      
      // 表单验证
      formRules: {
        beginString: [{ required: true, message: '请选择协议版本', trigger: 'change' }],
        senderCompID: [{ required: true, message: '请输入发送方标识', trigger: 'blur' }],
        targetCompID: [{ required: true, message: '请输入接收方标识', trigger: 'blur' }]
      },
      
      // Session数据（新增userId字段）
      sessions: [
        {
          sessionId: 'FIX.4.4:BROKER_X:EXCHANGE_A',
          beginString: 'FIX.4.4',
          senderCompID: 'BROKER_X',
          targetCompID: 'EXCHANGE_A',
          userId: 'U001', // 关联用户U001
          status: 'active',
          createTime: '2023-10-01 09:30:00'
        },
        {
          sessionId: 'FIX.5.0:BROKER_X:EXCHANGE_B',
          beginString: 'FIX.5.0',
          senderCompID: 'BROKER_X',
          targetCompID: 'EXCHANGE_B',
          userId: 'U001', // 关联用户U001
          status: 'offline',
          createTime: '2023-10-02 10:15:00'
        },
        {
          sessionId: 'FIXT.1.1:BANK_Y:CLEARING_C',
          beginString: 'FIXT.1.1',
          senderCompID: 'BANK_Y',
          targetCompID: 'CLEARING_C',
          userId: 'U002', // 关联用户U002
          status: 'error',
          createTime: '2023-09-28 14:20:00'
        }
      ]
    };
  },
  computed: {
    // 筛选后的Session（增加按用户筛选）
    filteredSessions() {
      return this.sessions.filter(session => {
        const matchSearch = this.searchKeyword
          ? session.sessionId.includes(this.searchKeyword) ||
            session.senderCompID.includes(this.searchKeyword)
          : true;
        
        const matchStatus = this.filterStatus ? session.status === this.filterStatus : true;
        
        // 按用户筛选
        const matchUser = this.filterUserId ? session.userId === this.filterUserId : true;
        
        return matchSearch && matchStatus && matchUser;
      });
    }
  },
  methods: {
    // 搜索与筛选
    handleSearch() { this.currentPage = 1; },
    handleFilter() { this.currentPage = 1; },
    resetFilter() {
      this.searchKeyword = '';
      this.filterStatus = '';
      this.filterUserId = '';
      this.currentPage = 1;
    },
    
    // 分页
    handleSizeChange(size) { this.pageSize = size; },
    handleCurrentChange(page) { this.currentPage = page; },
    
    // 打开新增/编辑弹窗
    openAddDialog() {
      this.isEdit = false;
      this.formData = {
        beginString: '',
        senderCompID: '',
        targetCompID: '',
        userId: '',
        heartbeatInterval: 30
      };
      this.dialogVisible = true;
    },
    openEditDialog(row) {
      this.isEdit = true;
      this.formData = { ...row };
      this.dialogVisible = true;
    },
    
    // 提交表单（维护userId关联）
    submitForm() {
      this.$refs.sessionForm.validate(valid => {
        if (valid) {
          const sessionId = `${this.formData.beginString}:${this.formData.senderCompID}:${this.formData.targetCompID}`;
          
          if (!this.isEdit && this.sessions.some(s => s.sessionId === sessionId)) {
            this.$message.error('Session ID已存在');
            return;
          }
          
          if (this.isEdit) {
            const index = this.sessions.findIndex(s => s.sessionId === this.formData.sessionId);
            this.sessions.splice(index, 1, { ...this.formData, sessionId });
          } else {
            this.sessions.unshift({
              ...this.formData,
              sessionId,
              status: 'offline',
              createTime: new Date().toLocaleString()
            });
          }
          
          this.$message.success(this.isEdit ? '编辑成功' : '新增成功');
          this.dialogVisible = false;
        }
      });
    },
    
    // 查看详情
    viewSessionDetail(row) {
      this.detailData = { ...row };
      this.detailVisible = true;
    },
    
    // 删除Session
    handleDelete(row) {
      this.$confirm(`确定删除Session [${row.sessionId}]？`, '确认删除', { type: 'warning' })
        .then(() => {
          const index = this.sessions.findIndex(s => s.sessionId === row.sessionId);
          this.sessions.splice(index, 1);
          this.$message.success('删除成功');
        });
    },
    
    // 根据userId获取用户名（辅助方法）
    getUserUsername(userId) {
      const user = this.users.find(u => u.userId === userId);
      return user ? user.username : null;
    }
  }
};
</script>

<style scoped>
/* 样式与之前类似，略 */
</style>



<template>
  <el-tabs v-model="activeTab" type="card" style="height: 100vh;">
    <el-tab-pane label="用户管理" name="user">
      <UserManager
        :all-sessions="sessions"
        @update-session-user="syncSessionUser"
        @goto-session-detail="gotoSessionDetail"
      ></UserManager>
    </el-tab-pane>
    <el-tab-pane label="Session管理" name="session">
      <SessionManagerWithUser
        :users="users"
        ref="sessionManager"
      ></SessionManagerWithUser>
    </el-tab-pane>
  </el-tabs>
</template>

<script>
import UserManager from './UserManager.vue';
import SessionManagerWithUser from './SessionManagerWithUser.vue';

export default {
  components: { UserManager, SessionManagerWithUser },
  data() {
    return {
      activeTab: 'user',
      // 全局用户数据（实际项目中从API获取）
      users: [],
      // 全局Session数据
      sessions: []
    };
  },
  mounted() {
    // 初始化数据（模拟API请求）
    this.users = [/* 用户数据 */];
    this.sessions = [/* Session数据 */];
  },
  methods: {
    // 同步用户关联的Session（当用户编辑关联Session时）
    syncSessionUser(user) {
      // 实际项目中需更新Session的userId字段
      this.sessions.forEach(session => {
        session.userId = user.sessionIds.includes(session.sessionId) ? user.userId : session.userId;
      });
    },
    // 跳转到指定Session详情
    gotoSessionDetail(sessionId) {
      this.activeTab = 'session';
      // 调用Session组件的查看详情方法（实际项目中可通过路由实现）
      const session = this.sessions.find(s => s.sessionId === sessionId);
      if (session) {
        this.$refs.sessionManager.viewSessionDetail(session);
      }
    }
  }
};
</script>




